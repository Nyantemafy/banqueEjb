<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BanqueEjb | Interface de Gestion</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- PAGE DE CONNEXION -->
    <div id="loginPage" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:24px; z-index:1000; background: var(--bg);">
        <div class="card" style="max-width:680px; width:96%; margin:auto;">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-sign-in-alt"></i></div>
                <h3 class="card-title" style="font-size: 1.4rem;">Connexion</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Prénom</label>
                    <input type="text" id="loginPrenom" class="form-input" placeholder="Jean">
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" class="form-input" placeholder="••••••">
                    </div>
                </div>
                <button id="loginBtn" class="btn btn-primary btn-full"><i class="fas fa-unlock"></i> Se connecter</button>
            </div>
        </div>
    </div>

    <!-- APPLICATION -->
    <div id="appRoot" class="app-container" style="display:none;">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="logo-text">BanqueEjb</div>
            </div>
            <nav class="nav">
                <a href="#" class="nav-item active" data-tab="clients">
                    <i class="fas fa-users"></i>
                    <span class="nav-text">Clients</span>
                </a>
                <a href="#" class="nav-item" data-tab="compteCourant">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-text">Compte Courant</span>
                </a>
                <a href="#" class="nav-item" data-tab="compteDepot">
                    <i class="fas fa-piggy-bank"></i>
                    <span class="nav-text">Compte Dépôt</span>
                </a>
                <a href="#" class="nav-item" data-tab="prets">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span class="nav-text">Prêts</span>
                </a>
            </nav>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content">
            <div class="top-bar">
                <div class="page-title" id="pageTitle">Gestion des Clients</div>
                <div class="user-menu">
                    <button id="logoutBtn" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Se déconnecter</button>
                </div>
            </div>

            <div class="content-area">
                <!-- =================== TAB CLIENTS =================== -->
                <div id="clients" class="tab-content">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Gestion des Clients</h2>
                        </div>
                        <div class="alert" id="clientAlert"></div>

                        <div class="card-grid">
                            <!-- Créer un client -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <h3 class="card-title">Nouveau Client</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Numéro client *</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-id-card"></i>
                                            <input type="text" id="clientNumero" class="form-input" placeholder="CLIENT999">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nom *</label>
                                        <input type="text" id="clientNom" class="form-input" placeholder="Dupont">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Prénom *</label>
                                        <input type="text" id="clientPrenom" class="form-input" placeholder="Jean">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-envelope"></i>
                                            <input type="email" id="clientEmail" class="form-input" placeholder="jean.dupont@email.com">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Mot de passe</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-lock"></i>
                                            <input type="password" id="clientPassword" class="form-input" placeholder="••••••">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Rôle</label>
                                        <select id="clientRole" class="form-input">
                                            <option value="USER">Utilisateur</option>
                                            <option value="ADMIN">Administrateur</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary btn-full" id="createClientBtn">
                                        <i class="fas fa-plus-circle"></i> Créer Client
                                    </button>
                                </div>
                            </div>

                            <!-- Rechercher un client + Détails -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h3 class="card-title">Rechercher Client</h3>
                                </div>
                                <div class="card-body">
                                    <div class="subgrid">
                                        <div class="panel">
                                            <h4><i class="fas fa-search"></i> Recherche</h4>
                                            <div class="form-group">
                                                <label class="form-label">Numéro client</label>
                                                <div class="input-with-icon">
                                                    <i class="fas fa-id-card"></i>
                                                    <input type="text" id="searchClientNumero" class="form-input" placeholder="CLIENT001">
                                                </div>
                                            </div>
                                            <button class="btn btn-primary btn-full" id="searchClientBtn">
                                                <i class="fas fa-search"></i> Rechercher
                                            </button>
                                        </div>
                                        <div class="panel">
                                            <h4><i class="fas fa-user"></i> Détails</h4>
                                            <div id="clientDetails"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- =================== TAB COMPTE COURANT =================== -->
                <div id="compteCourant" class="tab-content hidden">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Compte Courant (Java EJB)</h2>
                        </div>
                        <div class="alert" id="ccAlert"></div>

                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Numéro de compte</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-credit-card"></i>
                                        <input type="text" id="ccNumero" class="form-input" placeholder="CC-CLIENT001">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <h3 class="card-title">Actions</h3>
                            </div>
                            <div class="card-body">
                                <div class="subgrid">
                                    <div class="panel">
                                        <h4><i class="fas fa-wallet"></i> Solde</h4>
                                        <button class="btn btn-primary btn-full" id="ccSoldeBtn">
                                            <i class="fas fa-eye"></i> Voir Solde
                                        </button>
                                        <div id="ccSolde" class="balance-display"></div>
                                    </div>
                                    <div class="panel">
                                        <h4><i class="fas fa-arrow-down"></i> Déposer</h4>
                                        <div class="form-group">
                                            <label class="form-label">Montant (€)</label>
                                            <div class="input-with-icon">
                                                <i class="fas fa-euro-sign"></i>
                                                <input type="number" id="ccDepotMontant" class="form-input" placeholder="1000" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <button class="btn btn-success btn-full" id="ccDepotBtn">
                                            <i class="fas fa-plus"></i> Déposer
                                        </button>
                                    </div>
                                    <div class="panel">
                                        <h4><i class="fas fa-arrow-up"></i> Retirer</h4>
                                        <div class="form-group">
                                            <label class="form-label">Montant (€)</label>
                                            <div class="input-with-icon">
                                                <i class="fas fa-euro-sign"></i>
                                                <input type="number" id="ccRetraitMontant" class="form-input" placeholder="500" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <button class="btn btn-danger btn-full" id="ccRetraitBtn">
                                            <i class="fas fa-minus"></i> Retirer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historique -->
                        <div class="card mt-20">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <h3 class="card-title">Historique des transactions</h3>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" id="ccHistoriqueBtn">
                                    <i class="fas fa-list"></i> Voir Historique
                                </button>
                                <div id="ccHistorique" class="transaction-history mt-20"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =================== TAB COMPTE DÉPÔT =================== -->
                <div id="compteDepot" class="tab-content hidden">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Compte Dépôt (.NET Minimal API)</h2>
                        </div>
                        <div class="alert" id="depotAlert"></div>

                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Numéro de compte</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-piggy-bank"></i>
                                        <input type="text" id="depotNumero" class="form-input" placeholder="DEP-CLIENT001">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <h3 class="card-title">Actions</h3>
                            </div>
                            <div class="card-body">
                                <div class="subgrid">
                                    <div class="panel">
                                        <h4><i class="fas fa-wallet"></i> Solde</h4>
                                        <button class="btn btn-primary btn-full" id="depotSoldeBtn">
                                            <i class="fas fa-eye"></i> Voir Solde
                                        </button>
                                        <div id="depotSolde" class="balance-display"></div>
                                    </div>
                                    <div class="panel">
                                        <h4><i class="fas fa-arrow-down"></i> Déposer</h4>
                                        <div class="form-group">
                                            <label class="form-label">Montant (€)</label>
                                            <div class="input-with-icon">
                                                <i class="fas fa-euro-sign"></i>
                                                <input type="number" id="depotDepotMontant" class="form-input" placeholder="5000" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <button class="btn btn-success btn-full" id="depotDepotBtn">
                                            <i class="fas fa-plus"></i> Déposer
                                        </button>
                                    </div>
                                    <div class="panel">
                                        <h4><i class="fas fa-arrow-up"></i> Retirer</h4>
                                        <div class="form-group">
                                            <label class="form-label">Montant (€)</label>
                                            <div class="input-with-icon">
                                                <i class="fas fa-euro-sign"></i>
                                                <input type="number" id="depotRetraitMontant" class="form-input" placeholder="1000" min="0" step="0.01">
                                            </div>
                                        </div>
                                        <button class="btn btn-danger btn-full" id="depotRetraitBtn">
                                            <i class="fas fa-minus"></i> Retirer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =================== TAB PRÊTS =================== -->
                <div id="prets" class="tab-content hidden">
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Gestion des Prêts</h2>
                        </div>
                        <div class="alert" id="pretAlert"></div>

                        <div class="card-grid">
                            <!-- Demander un prêt -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-file-contract"></i>
                                    </div>
                                    <h3 class="card-title">Demander un prêt</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Numéro client</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-id-card"></i>
                                            <input type="text" id="pretClientNumero" class="form-input" placeholder="CLIENT001">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Montant (€)</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-euro-sign"></i>
                                            <input type="number" id="pretMontant" class="form-input" placeholder="50000" min="0" step="100">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Durée (mois)</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-calendar-alt"></i>
                                            <input type="number" id="pretDuree" class="form-input" placeholder="240" min="1">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Objet du prêt</label>
                                        <input type="text" id="pretObjet" class="form-input" placeholder="Achat immobilier">
                                    </div>
                                    <button class="btn btn-primary btn-full" id="pretDemandeBtn">
                                        <i class="fas fa-paper-plane"></i> Soumettre Demande
                                    </button>
                                </div>
                            </div>

                            <!-- Calculer mensualité -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-calculator"></i>
                                    </div>
                                    <h3 class="card-title">Calculer Mensualité</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="form-label">Montant (€)</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-euro-sign"></i>
                                            <input type="number" id="calcMontant" class="form-input" placeholder="50000" min="0" step="100">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Durée (mois)</label>
                                        <div class="input-with-icon">
                                            <i class="fas fa-calendar-alt"></i>
                                            <input type="number" id="calcDuree" class="form-input" placeholder="240" min="1">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-full" id="pretCalculBtn">
                                        <i class="fas fa-calculator"></i> Calculer
                                    </button>
                                    <div id="mensualiteResult" class="mt-20 text-center"></div>
                                </div>
                            </div>

                            <!-- Connexion / Statut -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    <h3 class="card-title">Connexion</h3>
                                </div>
                                <div class="card-body">
                                    <div id="adminStatus" class="mt-10 text-center text-muted">Non connecté</div>
                                    <button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="showLoginPage()">
                                        <i class="fas fa-user"></i> Changer d'utilisateur
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des demandes -->
                        <div class="card mt-20">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fas fa-list"></i>
                                </div>
                                <h3 class="card-title">Demandes en attente</h3>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" id="pretListeBtn">
                                    <i class="fas fa-sync-alt"></i> Actualiser la liste
                                </button>
                                <div id="demandesList" class="mt-20"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- (Overlay supprimé: passage à une vraie page de connexion) -->

    <!-- Include JS modules -->
    <script src="js/config.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/compte-courant.js"></script>
    <script src="js/compte-depot.js"></script>
    <script src="js/clients.js"></script>
    <script src="js/prets.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Navigation entre les onglets
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Mettre à jour la navigation
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                this.classList.add('active');
                
                // Mettre à jour le contenu
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabId).classList.remove('hidden');
                
                // Mettre à jour le titre de la page
                const pageTitle = document.getElementById('pageTitle');
                switch(tabId) {
                    case 'clients':
                        pageTitle.textContent = 'Gestion des Clients';
                        break;
                    case 'compteCourant':
                        pageTitle.textContent = 'Compte Courant';
                        break;
                    case 'compteDepot':
                        pageTitle.textContent = 'Compte Dépôt';
                        break;
                    case 'prets':
                        pageTitle.textContent = 'Gestion des Prêts';
                        break;
                }
            });
        });

        // Simulation d'alerte
        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        // Simulation de fonctionnalités
        document.getElementById('createClientBtn').addEventListener('click', () => {
            showAlert('clientAlert', 'Client créé avec succès!', 'success');
        });

        document.getElementById('searchClientBtn').addEventListener('click', () => {
            showAlert('clientAlert', 'Recherche effectuée!', 'success');
        });

        // L'événement ccSoldeBtn est géré par CompteCourantModule (via js/compte-courant.js)

        document.getElementById('pretCalculBtn').addEventListener('click', () => {
            document.getElementById('mensualiteResult').innerHTML = `
                <h3>Résultat du calcul</h3>
                <p class="text-muted">Mensualité estimée:</p>
                <div class="balance-display">312,50 €</div>
            `;
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Interface BanqueEjb initialisée');
            initLoginGate();
            updateLoginStatusUI();
        });

        // Gestion page login / app
        async function tryLogin() {
            const prenom = (document.getElementById('loginPrenom').value || '').trim();
            const password = (document.getElementById('loginPassword').value || '').trim();
            if (!prenom || !password) {
                UIManager.showAlert('loginAlert', 'Entrez prénom et mot de passe', true);
                return false;
            }
            try {
                // Auth coté front: récupère la liste des clients puis filtre par prenom et motDePasse (si disponible)
                const clients = await apiClient.getAllClients();
                const client = (clients || []).find(c => (c.prenom || '').toLowerCase() === prenom.toLowerCase());
                if (!client) {
                    UIManager.showAlert('loginAlert', 'Utilisateur introuvable', true);
                    return false;
                }
                // Supporte c.motDePasse ou c.password si renvoyé par l'API
                const storedPass = client.motDePasse || client.password || '';
                if (storedPass && storedPass !== password) {
                    UIManager.showAlert('loginAlert', 'Mot de passe invalide', true);
                    return false;
                }
                // Connexion OK
                window.localStorage.setItem('role', (client.role || 'USER').toString().toLowerCase());
                window.localStorage.setItem('numeroClient', client.numeroClient || client.numero_client || '');
                if ((client.role || '').toUpperCase() === 'ADMIN') {
                    window.localStorage.setItem('adminClient', client.numeroClient || client.numero_client || '');
                } else {
                    window.localStorage.removeItem('adminClient');
                }
                return true;
            } catch (e) {
                UIManager.showAlert('loginAlert', 'Erreur de connexion au serveur', true);
                return false;
            }
        }

        function initLoginGate() {
            const app = document.getElementById('appRoot');
            const login = document.getElementById('loginPage');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            const hasRole = !!window.localStorage.getItem('role');
            if (hasRole) {
                if (login) login.style.display = 'none';
                if (app) app.style.display = 'flex';
            } else {
                if (login) login.style.display = 'flex';
                if (app) app.style.display = 'none';
            }

            if (loginBtn) {
                loginBtn.addEventListener('click', async () => {
                    const ok = await tryLogin();
                    if (ok) {
                        if (login) login.style.display = 'none';
                        if (app) app.style.display = 'flex';
                        updateLoginStatusUI();
                        // Forcer l'onglet prêts à refléter les boutons si besoin
                        // (rien à faire ici, PretsModule lit localStorage au rendu)
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    window.localStorage.removeItem('role');
                    window.localStorage.removeItem('adminClient');
                    window.localStorage.removeItem('numeroClient');
                    if (app) app.style.display = 'none';
                    if (login) login.style.display = 'flex';
                    updateLoginStatusUI();
                });
            }
        }

        function updateLoginStatusUI() {
            const status = document.getElementById('adminStatus');
            const role = window.localStorage.getItem('role');
            const adminNumero = window.localStorage.getItem('adminClient');
            if (!status) return;
            if (role === 'admin') {
                status.textContent = `Connecté en admin: ${adminNumero || ''}`;
            } else if (role === 'user') {
                status.textContent = 'Connecté en utilisateur';
            } else {
                status.textContent = 'Non connecté';
            }
        }

        // Raccourci global pour afficher la page de login
        window.showLoginPage = function() {
            const app = document.getElementById('appRoot');
            const login = document.getElementById('loginPage');
            if (app) app.style.display = 'none';
            if (login) login.style.display = 'flex';
        };
    </script>
</body>
</html>